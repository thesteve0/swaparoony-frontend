#!/bin/bash
#
# S2I assemble script for swaparoony-frontend
# This script is responsible for building the application artifacts from source
# and placing them into appropriate directories for the run script to execute
#

set -e

echo "---> Running default S2I assemble script..."
# Execute the default assemble script to handle Node.js build (this installs nginx-binaries)
/usr/libexec/s2i/assemble

echo "---> Setting up nginx binary..."
# The nginx-binaries package downloads nginx to node_modules/.bin/
if [ -f "./node_modules/.bin/nginx-binaries" ]; then
    echo "---> Downloading nginx binary via nginx-binaries package..."
    ./node_modules/.bin/nginx-binaries --help || true
    
    # Create a symlink so our start script can find nginx
    if [ ! -L "./nginx" ]; then
        echo "---> Creating nginx symlink..."
        # Find the actual nginx binary path
        NGINX_PATH=$(find ./node_modules/nginx-binaries -name "nginx*" -type f -executable 2>/dev/null | head -1)
        if [ -n "$NGINX_PATH" ]; then
            ln -sf "$NGINX_PATH" ./nginx
            echo "---> nginx binary linked at $(pwd)/nginx"
        else
            echo "---> Warning: nginx binary not found in nginx-binaries"
        fi
    fi
else
    echo "---> Warning: nginx-binaries not found"
fi

echo "---> Custom assemble script completed"