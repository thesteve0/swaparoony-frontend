#!/bin/bash
#
# S2I assemble script for swaparoony-frontend
# This script is responsible for building the application artifacts from source
# and placing them into appropriate directories for the run script to execute
#

set -e

echo "---> Running default S2I assemble script..."
# Execute the default assemble script to handle Node.js build (this installs nginx-binaries)
/usr/libexec/s2i/assemble

echo "---> Setting up nginx binary using JS API..."
# Use our custom Node.js script to download nginx binary
if [ -f "./download-nginx.mjs" ]; then
    echo "---> Running nginx download script..."
    node ./download-nginx.mjs
    
    # Verify nginx binary was created
    if [ -x "./nginx" ]; then
        echo "---> nginx binary successfully downloaded and ready"
        echo "---> nginx location: $(pwd)/nginx"
        # Test nginx
        ./nginx -v 2>&1 | head -1 || echo "nginx version check failed"
    else
        echo "---> ERROR: nginx binary not found at ./nginx"
        echo "---> Contents of current directory:"
        ls -la ./ | grep nginx || echo "No nginx files found"
    fi
else
    echo "---> ERROR: download-nginx.mjs script not found"
    ls -la ./ | grep -E "\.(mjs|js)$" || echo "No JS files found"
fi

echo "---> Custom assemble script completed"